<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Base-12 3D Turtle Walk Gallery</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a12;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }
        h1 {
            color: #9C27B0;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 24px;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #9C27B0;
            text-decoration: none;
        }
        .back-link:hover { text-decoration: underline; }

        /* Mapping legend */
        .mapping-legend {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 16px 24px;
            margin-bottom: 28px;
            border-left: 4px solid #9C27B0;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }
        .mapping-legend h3 {
            color: #E91E63;
            margin: 0 0 10px 0;
            font-size: 15px;
        }
        .mapping-legend p {
            color: #aaa;
            font-size: 13px;
            margin: 0 0 10px 0;
        }
        .mapping-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin-bottom: 10px;
        }
        .mapping-table th {
            color: #9C27B0;
            text-align: left;
            padding: 4px 8px;
            border-bottom: 1px solid #3a3a5a;
            font-weight: 500;
        }
        .mapping-table td {
            padding: 3px 8px;
            color: #ccc;
            font-family: 'SF Mono', 'Fira Code', monospace;
        }
        .mapping-table .trans { color: #4CAF50; }
        .mapping-table .rot { color: #FF9800; }
        .mapping-table .digit { color: #666; }

        .named-mappings {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .named-mapping {
            background: #2a2a4a;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-family: 'SF Mono', 'Fira Code', monospace;
        }
        .named-mapping .mname { color: #E91E63; font-family: inherit; }
        .named-mapping .mvals { color: #888; }

        /* Category sections */
        .category { margin-bottom: 40px; }
        .category h2 {
            color: #7B1FA2;
            border-bottom: 1px solid #3a3a5a;
            padding-bottom: 8px;
            margin-bottom: 16px;
        }
        .subcategory {
            color: #9575CD;
            font-size: 15px;
            margin: 16px 0 10px 0;
            border-left: 3px solid #4a3a6a;
            padding-left: 10px;
        }

        /* Mapping row label */
        .mapping-row-label {
            font-size: 12px;
            color: #888;
            margin: 12px 0 6px 0;
            padding: 3px 10px;
            background: #1a1a2e;
            border-radius: 4px;
            display: inline-block;
        }
        .mapping-row-label .mrl-name { color: #E91E63; font-weight: 500; }
        .mapping-row-label .mrl-count { color: #555; }

        /* Gallery grid */
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }
        .walk-card {
            background: #1a1a2e;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .walk-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(156, 39, 176, 0.3);
        }
        .walk-card img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            display: block;
            background: #0a0a12;
        }
        .walk-card .info { padding: 10px 12px; }
        .walk-card .name {
            color: #E91E63;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .walk-card .meta {
            color: #666;
            font-size: 11px;
            margin-top: 4px;
        }
        .walk-card .kind {
            margin-top: 6px;
            font-size: 10px;
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .walk-card .kind.empirical {
            color: #9be7a8;
            background: #17301b;
        }
        .walk-card .kind.mathematical {
            color: #ffd180;
            background: #3a2a12;
        }
        .walk-card .kind.pcpri {
            color: #9ecbff;
            background: #15253c;
        }
        .walk-card .kind.unknown {
            color: #ff9e9e;
            background: #3a1717;
        }
        .walk-card .sources {
            margin-top: 6px;
            font-size: 11px;
            line-height: 1.3;
        }
        .walk-card .source-link {
            color: #64B5F6;
            text-decoration: none;
            margin-right: 8px;
            white-space: nowrap;
        }
        .walk-card .source-link:hover { text-decoration: underline; }
        .walk-card .mapping-tag {
            display: inline-block;
            font-size: 10px;
            padding: 1px 6px;
            border-radius: 3px;
            margin-top: 3px;
        }
        .mapping-tag.optimal { background: #1a3a1a; color: #4CAF50; }
        .mapping-tag.spiral { background: #1a1a4a; color: #64B5F6; }
        .mapping-tag.identity { background: #3a3a3a; color: #999; }
        .mapping-tag.other { background: #4a3a1a; color: #FFC107; }

        /* Filter bar */
        .filter-bar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            justify-content: center;
        }
        .filter-btn {
            background: #2a2a4a;
            color: #aaa;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        .filter-btn:hover, .filter-btn.active {
            background: #9C27B0;
            color: white;
        }

        #walk-count {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
        }

        footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #2a2a4a;
            color: #666;
            font-size: 12px;
            text-align: center;
        }
        footer a { color: #9C27B0; }

        /* Mapping selector */
        .mapping-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            margin-bottom: 16px;
        }
        .mapping-selector label { color: #888; font-size: 13px; }
        .mapping-selector select {
            background: #2a2a4a;
            color: #E91E63;
            border: 1px solid #4a3a6a;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'SF Mono', 'Fira Code', monospace;
            cursor: pointer;
        }
        .mapping-selector select:focus { outline: 1px solid #9C27B0; }
        .mapping-selector .mapping-vals {
            color: #555;
            font-size: 11px;
            font-family: 'SF Mono', 'Fira Code', monospace;
        }

        /* Progress bar */
        #render-progress {
            display: none;
            text-align: center;
            margin: 10px 0;
        }
        #render-progress .bar-bg {
            background: #2a2a4a;
            border-radius: 4px;
            height: 6px;
            max-width: 400px;
            margin: 6px auto;
            overflow: hidden;
        }
        #render-progress .bar-fill {
            background: #9C27B0;
            height: 100%;
            width: 0%;
            transition: width 0.1s;
        }
        #render-progress .status { color: #888; font-size: 12px; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="walk_renderer.js"></script>
    <script src="walk_config.js"></script>
</head>
<body>
    <a href="index.html" class="back-link">&larr; Back to Visualizations</a>
    <h1>Base-12 3D Turtle Walk Gallery</h1>
    <p class="subtitle">Each data source is converted to base-12, then walked through 3D space using translation and rotation commands</p>

    <div class="mapping-legend">
        <h3>Base-12 Turtle Walk</h3>
        <p>Each value 0&ndash;11 is mapped to one of 12 actions: 6 translations (&plusmn;X, &plusmn;Y, &plusmn;Z) and 6 rotations (&plusmn;RX, &plusmn;RY, &plusmn;RZ at 15&deg;). The mapping order determines which digit triggers which action.</p>
        <table class="mapping-table">
            <tr>
                <th>Action</th>
                <th><span class="trans">+X</span></th>
                <th><span class="trans">&minus;X</span></th>
                <th><span class="trans">+Y</span></th>
                <th><span class="trans">&minus;Y</span></th>
                <th><span class="trans">+Z</span></th>
                <th><span class="trans">&minus;Z</span></th>
                <th><span class="rot">+RX</span></th>
                <th><span class="rot">&minus;RX</span></th>
                <th><span class="rot">+RY</span></th>
                <th><span class="rot">&minus;RY</span></th>
                <th><span class="rot">+RZ</span></th>
                <th><span class="rot">&minus;RZ</span></th>
            </tr>
            <tr>
                <td style="color:#9C27B0">Action #</td>
                <td class="digit">0</td><td class="digit">1</td><td class="digit">2</td><td class="digit">3</td><td class="digit">4</td><td class="digit">5</td>
                <td class="digit">6</td><td class="digit">7</td><td class="digit">8</td><td class="digit">9</td><td class="digit">10</td><td class="digit">11</td>
            </tr>
        </table>
        <p style="font-size:12px;color:#777">A <strong>mapping</strong> reorders which input digit triggers which action. For example, with the Optimal mapping, input digit 8 triggers action 10 (+RZ) instead of action 8 (+RY).</p>
        <div class="named-mappings" id="mapping-chips"></div>
    </div>

    <div class="mapping-selector">
        <label>Mapping:</label>
        <select id="mapping-select">
            <option value="Identity" selected>Identity [0,1,2,3,4,5,6,7,8,9,10,11]</option>
            <option value="Optimal">Optimal [0,1,2,3,4,5,6,7,10,9,8,11]</option>
            <option value="Spiral">Spiral [0,2,4,6,8,10,1,3,5,7,9,11]</option>
            <option value="LCG">LCG [3,7,11,10,4,0,9,6,5,1,2,8]</option>
            <option value="Stock-opt">Stock-opt [1,0,2,4,10,5,6,9,8,7,3,11]</option>
        </select>
        <span class="mapping-vals" id="mapping-vals-display"></span>
    </div>

    <div id="render-progress">
        <span class="status" id="render-status">Re-rendering walks...</span>
        <div class="bar-bg"><div class="bar-fill" id="render-bar"></div></div>
    </div>

    <div class="filter-bar">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="audio">Audio</button>
        <button class="filter-btn" data-filter="languages">Languages</button>
        <button class="filter-btn" data-filter="animals">Animals</button>
        <button class="filter-btn" data-filter="environment">Environment</button>
        <button class="filter-btn" data-filter="cosmos">Cosmos</button>
        <button class="filter-btn" data-filter="dna">DNA</button>
        <button class="filter-btn" data-filter="finance">Finance</button>
        <button class="filter-btn" data-filter="math">Mathematical</button>
        <button class="filter-btn" data-filter="games">Games</button>
        <button class="filter-btn" data-filter="pcpri">Phase-Coherent Pseudorandom Input</button>
    </div>

    <div id="walk-count"></div>
    <div id="gallery-container"></div>

    <footer>
        <p>Thumbnails rendered with Three.js. All data from public domain or freely accessible sources.</p>
        <p><a href="https://github.com/gwild/pcpri">PCPRI Project</a></p>
    </footer>

    <script>
        // Use shared config from walk_config.js (SSOT)
        const MAPPINGS = window.MAPPINGS;
        const FILE_INFO = window.FILE_INFO;
        const FILE_SOURCES = window.FILE_SOURCES;
        const FILE_PROVENANCE = window.FILE_PROVENANCE;
        const WALK_SOURCE_OVERRIDES = window.WALK_SOURCE_OVERRIDES;
        const BASE4_FILES = window.BASE4_FILES;
        const WALK_MAPPING_OVERRIDES = window.WALK_MAPPING_OVERRIDES;
        const WALK_SUB_OVERRIDES = window.WALK_SUB_OVERRIDES;
        const WALK_CAT_OVERRIDES = window.WALK_CAT_OVERRIDES;
        const CAT_NAMES = window.CAT_NAMES;
        const HIDDEN_WALKS = window.HIDDEN_WALKS;
        const getFileInfo = window.getFileInfo;
        const getWalkSources = window.getWalkSources;
        const getWalkProvenance = window.getWalkProvenance;
        const provenanceLabel = window.provenanceLabel;
        const getWalkCat = window.getWalkCat;
        const getWalkSub = window.getWalkSub;
        const getWalkMapping = window.getWalkMapping;
        const mappingTagClass = window.mappingTagClass;
        const isBaseline = window.isBaseline;

        let allWalks = [];
        let currentFilter = 'all';

        async function loadManifest() {
            const resp = await fetch('thumbnails/manifest.json');
            allWalks = await resp.json();

            // Render mapping chips in legend
            const chipsEl = document.getElementById('mapping-chips');
            let chipsHtml = '';
            for (const [name, vals] of Object.entries(MAPPINGS)) {
                chipsHtml += `<span class="named-mapping"><span class="mname">${name}</span> <span class="mvals">[${vals.join(',')}]</span></span>`;
            }
            chipsEl.innerHTML = chipsHtml;

            renderGallery();

            // Apply default mapping from selector
            const defaultMapping = document.getElementById('mapping-select').value;
            if (defaultMapping) {
                switchMapping(defaultMapping);
            }
        }

        function renderGallery() {
            const container = document.getElementById('gallery-container');
            const countEl = document.getElementById('walk-count');

            // Start with all walks, exclude base-4 files
            let filtered = allWalks.filter(w => !BASE4_FILES.has(w.file) && getFileInfo(w.file));

            // Category filter
            if (currentFilter !== 'all') {
                filtered = filtered.filter(w => {
                    return getWalkCat(w.file, w.walk) === currentFilter;
                });
            }

            // Remove hidden duplicates/junk
            filtered = filtered.filter(w => !HIDDEN_WALKS.has(`${w.file}::${w.walk}`));

            // Hide baselines unless toggled
            filtered = filtered.filter(w => !isBaseline(w.walk));
            countEl.innerHTML = `Showing ${filtered.length} walks`;

            // Group by category, then subcategory (using per-walk overrides)
            const groups = {};
            for (const walk of filtered) {
                const info = getFileInfo(walk.file);
                if (!info) continue;
                const key = getWalkCat(walk.file, walk.walk);
                const sub = getWalkSub(walk.file, walk.walk);
                if (!groups[key]) groups[key] = {};
                if (!groups[key][sub]) groups[key][sub] = [];
                groups[key][sub].push(walk);
            }

            const catNames = {
                audio: 'Audio', languages: 'Languages', animals: 'Animals', environment: 'Environment', dna: 'DNA', cosmos: 'Cosmos',
                finance: 'Finance', math: 'Math', pcpri: 'Phase-Coherent Pseudorandom Input',
                games: 'Games'
            };

            // Sort walks within each subcategory alphabetically
            for (const catKey in groups) {
                for (const subKey in groups[catKey]) {
                    groups[catKey][subKey].sort((a, b) => a.walk.localeCompare(b.walk));
                }
            }

            // Mapping priority for row ordering (primary first, alternates below)
            const MAPPING_ORDER = ['Optimal', 'Spiral', 'Identity', 'Stock-opt', 'LCG'];

            function mappingPriority(m) {
                const idx = MAPPING_ORDER.indexOf(m);
                return idx >= 0 ? idx : 99;
            }

            // Strip redundant prefixes and suffixes from walk names
            function cleanWalkName(name) {
                return name
                    .replace(/^Nature:\s*/i, '')
                    .replace(/^Environment:\s*/i, '')
                    .replace(/^Electronic:\s*/i, '')
                    .replace(/^Jazz:\s*/i, '')
                    .replace(/^Speech:\s*/i, '')
                    .replace(/^Chess:\s*/i, '')
                    .replace(/^Go:\s*/i, '')
                    .replace(/\s*\(REAL\)\s*/i, '')
                    .replace(/\s*\(noise\)\s*/i, '')
                    .replace(/\s*\(baseline\)\s*/i, '')
                    .replace(/\s*\(theoretical\)\s*/i, '')
                    .replace(/\s*\(Birds?\)\s*/i, '')
                    .replace(/\s*Birds?\s*$/i, '')
                    .replace(/^Random\s*/i, 'Random')
                    .replace(/Giant Steps \(Coltrane\)/, 'Coltrane: Giant Steps')
                    .replace(/^Whale:\s*/i, '')
                    .replace(/_/g, ' ');
            }

            function renderCard(walk) {
                const walkKey = walk.file + '::' + walk.walk;
                const cleanName = cleanWalkName(walk.walk);
                const sources = getWalkSources(walk.file, walk.walk);
                const provenance = getWalkProvenance(walk.file);
                const displayName = cleanName.length > 30
                    ? cleanName.substring(0, 30) + '...'
                    : cleanName;
                const sourceHtml = sources.length > 0
                    ? `<div class="sources">${sources.map(s =>
                        `<a class="source-link" href="${s.url}" target="_blank" rel="noopener noreferrer">${s.label}</a>`
                    ).join('')}</div>`
                    : (provenance === 'empirical' ? `<div class="sources"><span class="source-link" style="color:#ff9e9e">Source missing</span></div>` : '');
                return `
                    <div class="walk-card" title="${cleanName}">
                        <img src="thumbnails/${walk.thumb}" alt="${cleanName}" loading="lazy" data-walk-key="${walkKey}">
                        <div class="info">
                            <div class="name">${displayName}</div>
                            <div class="kind ${provenance}">${provenanceLabel(provenance)}</div>
                            ${sourceHtml}
                        </div>
                    </div>
                `;
            }

            // Render
            let html = '';
            const catKeys = Object.keys(groups).sort((a, b) =>
                (catNames[a] || a).localeCompare(catNames[b] || b)
            );

            for (const catKey of catKeys) {
                const subs = groups[catKey];
                const subKeys = Object.keys(subs).sort();
                if (subKeys.length === 0) continue;

                const catName = catNames[catKey] || catKey;
                const totalInCat = subKeys.reduce((n, k) => n + subs[k].length, 0);
                html += `<div class="category" data-cat="${catKey}">`;
                html += `<h2>${catName} <span style="color:#666;font-size:14px;font-weight:normal">(${totalInCat})</span></h2>`;

                for (const subKey of subKeys) {
                    const walks = subs[subKey];
                    if (subKeys.length > 1) {
                        html += `<h3 class="subcategory">${subKey}</h3>`;
                    }

                    // Group walks by mapping within this subcategory
                    const byMapping = {};
                    for (const w of walks) {
                        const m = getWalkMapping(w.file, w.walk);
                        if (!byMapping[m]) byMapping[m] = [];
                        byMapping[m].push(w);
                    }

                    // Sort mapping groups: primary first, alternates below
                    const mappingKeys = Object.keys(byMapping).sort((a, b) =>
                        mappingPriority(a) - mappingPriority(b)
                    );

                    // Render all walks in flat grid (no mapping subdivision)
                    html += '<div class="gallery">';
                    for (const mKey of mappingKeys) {
                        for (const w of byMapping[mKey]) html += renderCard(w);
                    }
                    html += '</div>';
                }

                html += '</div>';
            }

            container.innerHTML = html;

        }

        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                renderGallery();
            });
        });

        loadManifest();

        // ============================================================
        // Mapping selector â€” re-walk and re-render all thumbnails
        // ============================================================
        let base12Index = null;     // { "file::walk": [base12 array] }
        let renderedCache = {};     // { "mappingName": { "file::walk": dataURI } }
        let originalThumbs = {};    // { "file::walk": "thumbnails/xxx.png" }
        let activeMapping = '';     // '' = as-generated

        async function loadBase12Index() {
            if (base12Index) return base12Index;
            const resp = await fetch('thumbnails/base12_index.json');
            base12Index = await resp.json();
            return base12Index;
        }

        function saveOriginalThumbs() {
            if (Object.keys(originalThumbs).length > 0) return;
            for (const w of allWalks) {
                originalThumbs[w.file + '::' + w.walk] = 'thumbnails/' + w.thumb;
            }
        }

        async function switchMapping(mappingName) {
            const progressEl = document.getElementById('render-progress');
            const barEl = document.getElementById('render-bar');
            const statusEl = document.getElementById('render-status');

            saveOriginalThumbs();

            if (!mappingName) {
                // Revert to original thumbnails
                activeMapping = '';
                document.querySelectorAll('.walk-card img').forEach(img => {
                    const key = img.dataset.walkKey;
                    if (key && originalThumbs[key]) img.src = originalThumbs[key];
                });
                // Restore mapping tags
                document.querySelectorAll('.walk-card .mapping-tag').forEach(tag => {
                    if (tag.dataset.origMapping) {
                        tag.textContent = tag.dataset.origMapping;
                        tag.className = 'mapping-tag ' + mappingTagClass(tag.dataset.origMapping);
                    }
                });
                return;
            }

            const mapping = MAPPINGS[mappingName];
            if (!mapping) return;

            // Check cache
            if (renderedCache[mappingName]) {
                applyRenderedImages(renderedCache[mappingName], mappingName);
                return;
            }

            // Show progress
            progressEl.style.display = 'block';
            statusEl.textContent = 'Loading base-12 data...';
            barEl.style.width = '0%';

            try {
                const index = await loadBase12Index();
                statusEl.textContent = `Re-rendering ${Object.keys(index).length} walks with ${mappingName}...`;

                // Point counts derived from base12 index (SSOT)
                const pointCounts = {};
                for (const [key, base12] of Object.entries(index)) {
                    pointCounts[key] = base12.length;
                }
                const rendered = await batchRender(index, mapping, (cur, total) => {
                    barEl.style.width = (cur / total * 100) + '%';
                    statusEl.textContent = `Rendering ${cur}/${total} walks...`;
                }, pointCounts);

                renderedCache[mappingName] = rendered;
                applyRenderedImages(rendered, mappingName);
            } catch (err) {
                statusEl.textContent = 'Error: ' + err.message;
                console.error(err);
            }

            setTimeout(() => { progressEl.style.display = 'none'; }, 500);
        }

        function applyRenderedImages(rendered, mappingName) {
            activeMapping = mappingName;
            document.querySelectorAll('.walk-card img').forEach(img => {
                const key = img.dataset.walkKey;
                if (key && rendered[key]) {
                    img.src = rendered[key];
                }
            });
            // Update all mapping tags to show the selected mapping
            const tagClass = mappingTagClass(mappingName);
            document.querySelectorAll('.walk-card .mapping-tag').forEach(tag => {
                if (!tag.dataset.origMapping) tag.dataset.origMapping = tag.textContent;
                tag.textContent = mappingName;
                tag.className = 'mapping-tag ' + tagClass;
            });
        }

        document.getElementById('mapping-select').addEventListener('change', (e) => {
            switchMapping(e.target.value);
        });
    </script>
</body>
</html>
